<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<title>Starter</title>
	<style type="text/css">
		table {
			border-collapse: collapse;
			table-layout: fixed;
		}
		td {
			border: 1px solid black;
			padding: 5px;
		}
		ul {
			display: flex;
			padding: 0;
  			margin: 0;
		}
		li {
			padding-right: 10px;
			padding-left: 10px;
		}
		#grid {
			display: flex;
			padding: 0;
  			margin: 0;
			height: 100px;
		}
		#info {
			position: absolute;
  			top: 50%;
  			left: 50%;
			width: 100%;
			height: 100%;
  			transform: translate(-50%, -50%);
			background-color: white;
			text-align: center;
		}
		#infoContainer {
			position: absolute;
			top: 50%;
			width: 80%;
			left: 10%;
			transform: translateY(-50%);
		}
		#nextInfo {
			left: 50%;
		}
	</style>
	</head>
<body id="main">
	<button id="infoButton" style="position: relative; margin-bottom: 20px";>About this Calculator</button>
	<ul style="list-style-type: none; margin: 0; padding: 0;">
		<div id="grid">
					
		</div>
		<li id="calculation">0</li>
		<li id="accuracy" style="margin-left: 150px">Estimated Accuracy: 100%</li>
	</ul>
	<!--<div id="calculation">0</div>-->
	<!--<button id="calculate">Calculate</button>-->
	<button id="next">Next Turn</button>
	<button id="clear">Clear</button>

	<div>
		<table style="width: 60%; float: left;">
			<tbody id="gags">
		
			</tbody>
		</table>
		<div id="gagInfo" style="width: 30%; float: right;">

		</div>
	</div>

	<script type="text/javascript">
		let initDmg = 0;
		let totalDmg = 0;
		let gags = [];
		//let initStatus = {};
		//let status = {};
		let initCogs = {"status": {}, "level": 13}
		let cogs = {"status": {}, "level": 13}
		let clickedGag;
		let hoveredGag = false;
		let infoPage = 1;
		let typingTimer;

		function nextPage(text) {
			while (text.firstChild) {
  				text.removeChild(text.firstChild);
			}

			let p = document.createElement("p");
			fetch(`/info?page=${infoPage}`).then(response => {
        		return response.json();
    		}).then((body) => {
				if (body.hasOwnProperty("content")) {
					let content = body.content;
					//console.log(content);
					for (let i = 0; i < content.length; i++) {
						p.textContent = content[i];
						text.appendChild(p);
						p = document.createElement("p");
					}
					let next = document.createElement("button");
					next.addEventListener("click", (event) => nextPage(text));
					next.textContent = "Next";
					next.style.float = "right";
					next.id = "nextInfo";
					text.appendChild(next);
					infoPage++;
				} else {
					document.getElementById("info").remove();
				}
			}).catch((error) => {
        		while (text.firstChild) {
  					text.removeChild(text.firstChild);
				}
				p.textContent = "Something went wrong with the server.";
				text.appendChild(p);
    		}); 
		}

		function infoButton(event) {
			infoPage = 1;
			let div = document.createElement("div");
			div.id = "info";
			document.getElementById("main").appendChild(div);
			let X = document.createElement("button");
			X.addEventListener("click", (event) => {
				div.remove();
			});
			X.textContent = "X";
			X.style.float = "right";
			div.appendChild(X);
			let text = document.createElement("div");
			text.id = "infoContainer";
			nextPage(text);
			div.appendChild(text);
		}
		
		let info = document.getElementById("infoButton")
		info.addEventListener("click", infoButton);

		function hideGagInfo(event) {
			let div = document.getElementById("gagInfo");
			while (div.firstChild) {
  				div.removeChild(div.firstChild);
			}
		}

		function showGagInfo(gagName) {
			let div = document.getElementById("gagInfo");
			while (div.firstChild) {
  				div.removeChild(div.firstChild);
			}

			if (gagName === undefined) {
				return;
			}
			
			fetch(`/gags?gag=${gagName}`).then(response => {
        		return response.json();
    		}).then((body) => {
				let gag = body.gag[0];
				let image = document.createElement("img");
				let name = document.createElement("p");
				let dmg = document.createElement("p");
				let acc = document.createElement("p");
				let targetNum = document.createElement("p");
				image.src = `images/${gag.gagname}_icon.png`;
				image.width = "50";
				image.height = "50";
				name.textContent = gag.gagname;
				if (gag.gagtype === "Lure") {
					dmg.textContent = "Lured Rounds: " + gag.statuseffect.lured.rounds;
				} else {
					dmg.textContent = "Damage: "
					if (gag.mindmg === gag.maxdmg) {
						dmg.textContent += gag.maxdmg;
					} else {
						dmg.textContent += gag.mindmg + "-" + gag.maxdmg;
					}
				}
				acc.textContent = "Accuracy: ";
				if (gag.accuracy < 0) {
					acc.textContent += "100% (Perfect)";
				} else if (gag.accuracy <= 50) {
					acc.textContent += gag.accuracy + "% (Very Low)";
				} else if (gag.accuracy < 70) {
					acc.textContent += gag.accuracy + "% (Low)";
				} else if (gag.accuracy < 80) {
					acc.textContent += gag.accuracy + "% (Medium)";
				} else {
					acc.textContent += gag.accuracy + "% (High)";
				}
				targetNum.textContent = "Affects: ";
				if (gag.targetnum < 0) {
					targetNum.textContent += "All";
				} else {
					targetNum.textContent += gag.targetnum;
				}
				if (gag.targetnum === 1) {
					if (gag.gagtype === "Toon-Up") {
						targetNum.textContent += " Toon";
					} else {
						targetNum.textContent += " Cog";
					}
				} else {
					if (gag.gagtype === "Toon-Up") {
						targetNum.textContent += " Toons";
					} else {
						targetNum.textContent += " Cogs";
					}
				}
				div.appendChild(image);
				div.appendChild(name);
				div.appendChild(dmg);
				div.appendChild(acc);
				div.appendChild(targetNum);
			}).catch((error) => {
        		while (div.firstChild) {
  					div.removeChild(div.firstChild);
				}
    		}); 
		}

		function gagDmgInput(value, gagIndex, event) {
			let keys = gagIndex.split(/\s+/);
			let gag = gags[parseInt(keys[1])];
			let dmg = parseInt(value);
			if (dmg < gag.mindmg) {
				gag.currDmg = gag.mindmg;
			} else if (dmg > gag.maxdmg) {
				gag.currDmg = gag.maxdmg;
			} else {
				gag.currDmg = dmg;
			}
			showGagInfo(gag.gagname);
			calculate();
		}

		function orgButton (gagIndex, event) {
			if (gags[gagIndex].statuseffect.hasOwnProperty("organic")) {
				delete gags[gagIndex].statuseffect.organic;
			} else {
				gags[gagIndex].statuseffect.organic = 0;
			}
			clickedGag = gags[gagIndex].gagname;
			showGagInfo(clickedGag);
			calculate();
		}

		function xButton (gagIndex, event) {
			gags.splice(gagIndex, 1);
			clickedGag = undefined;
			hideGagInfo();
			calculate();
		}

		function updateCalc() {
			let grid = document.getElementById("grid");
			while (grid.firstChild) {
  				grid.removeChild(grid.firstChild);
			}

			if (initDmg > 0 && gags.length > 0) {
				let cell = document.createElement("li");
				cell.textContent = initDmg;
				grid.appendChild(cell);
				let operator = document.createElement("li");
				operator.textContent = "+";
				grid.appendChild(operator);
			}

			let gagIndex = 1;
			for (let gag of gags) {
				let div = document.createElement("div");
				div.classList.add("gag");
				div.id = gagIndex - 1;
				let X = document.createElement("button");
				X.classList.add("gagButton");
				X.textContent = "X";
				X.addEventListener("click", (x) => xButton(div.id, x));
				div.appendChild(X);
				let org = document.createElement("button");
				org.classList.add("gagButton");
				org.textContent = "Org";
				org.style.float = "right";
				org.addEventListener("click", (x) => orgButton(div.id, x));
				div.appendChild(org);
				let cell = document.createElement("li");
				cell.classList.add("gagIcon");
				//cell.textContent = gag.gagname;
				let image = document.createElement("img");
				image.src = `images/${gag.gagname}_icon.png`;
				image.width = "30";
				image.height = "30";
				cell.appendChild(image);
				div.appendChild(cell);
				let gagInput = document.createElement("input");
				gagInput.value = `${gag.currDmg}`;
				gagInput.id = `input ${gagIndex - 1}`
				gagInput.style.width = "20px";
				gagInput.style.height = "10px";
				//gagInput.addEventListener('input', (x) => gagDmgInput(gagInput.value, gagInput.id, x));
				gagInput.addEventListener('keyup', () => {
        			clearTimeout(typingTimer);
        			if (gagInput.value) {
            			typingTimer = setTimeout((x) => gagDmgInput(gagInput.value, gagInput.id, x), 1000);
        			}
    			});
				gagInput.addEventListener('keydown', () => {
        			clearTimeout(typingTimer);
    			});
				div.appendChild(gagInput);
				let note = document.createElement("li");
				note.textContent = `${gag.mindmg}-${gag.maxdmg}`;
				note.style.fontSize = "10px";
				div.appendChild(note);
				grid.appendChild(div);
				let operator = document.createElement("li");
				if (gagIndex === gags.length) {
					operator.textContent = "=";
				} else {
					operator.textContent = "+";
				}
				grid.appendChild(operator);
				gagIndex++;
			}
		}

		//function calculate(event) {
		function calculate() {
			//for (let i = 0; i < cogs.length; i++) {
				fetch("/cogs",
        		{
        		headers: {
        		    'Accept': 'application/json',
        		    'Content-Type': 'application/json'
        		},
        		method: "POST",
				body: JSON.stringify({"cog": initCogs})}
    			).then(response => {
    		    	return response.json();
    			}).then((cog) => {
					if (cog.hasOwnProperty("cogData")) {
						initCogs = cog.cogData;
					}
					fetch("/calculate",
        				{
    		    		headers: {
    		    		    'Accept': 'application/json',
    		    		    'Content-Type': 'application/json'
    		    		},
    		    		method: "POST",
						//body: JSON.stringify({"gags": gags, "status": initStatus})}
						body: JSON.stringify({"gags": gags, "cogs": initCogs})}
    				).then(response => {
    				    return response.json();
    				}).then((body) => {
						//console.log(body.hasOwnProperty("totalDamage"));
    				    if (body.hasOwnProperty("totalDamage")) {
    				        let div = document.getElementById("calculation");
							let acc = document.getElementById("accuracy");
							//div.textContent = parseInt(div.textContent) + body.totalDamage;
							totalDmg = initDmg + body.totalDamage;
							div.textContent = totalDmg;
							acc.textContent = `Estimated Accuracy: ${body.totalAcc * 100}%`;
							//status = body.status
							cogs = body.cogs;
							updateCalc();
    				    } else {
    				        gags.pop();
    				    }
						//gags = [];
    				}).catch((error) => {
    				    //gags = [];
						gags.pop();
    				});
				}).catch((error) => {
        			;
    			});
			//}

			/*
			fetch("/calculate",
        		{
        		headers: {
        		    'Accept': 'application/json',
        		    'Content-Type': 'application/json'
        		},
        		method: "POST",
				//body: JSON.stringify({"gags": gags, "status": initStatus})}
				body: JSON.stringify({"gags": gags, "cogs": initCogs})}
    		).then(response => {
    		    return response.json();
    		}).then((body) => {
    		    if (body.hasOwnProperty("totalDamage")) {
    		        let div = document.getElementById("calculation");
					//div.textContent = parseInt(div.textContent) + body.totalDamage;
					totalDmg = initDmg + body.totalDamage;
					//console.log(body.totalAcc);
					div.textContent = totalDmg;
					//status = body.status
					cogs = body.cogs
					updateCalc();
    		    } else {
    		        gags.pop();
    		    }
				//gags = [];
    		}).catch((error) => {
    		    //gags = [];
				gags.pop();
    		});
			*/
		}
		function clearCalc(event) {
			let div = document.getElementById("calculation");
			div.textContent = 0;
			initDmg = 0;
			totalDmg = 0;
			let acc = document.getElementById("accuracy");
			acc.textContent = "Estimated Accuracy: 100%";
			gags = [];
			//initStatus = {};
			//status = {};
			initCogs = {"status": {}, "level": 13};
			cogs = {"status": {}, "level": 13};
			clickedGag = undefined;
			hideGagInfo();
			updateCalc();
		}
		function nextTurn(event) {
			gags = [];
			//initStatus = status;
			initCogs = cogs;
			initDmg = totalDmg;
			let acc = document.getElementById("accuracy");
			acc.textContent = "Estimated Accuracy: 100%";
			/*for (let pair of Object.entries(initStatus)) {
    			let stat = initStatus[pair[0]];
    			if (stat.rounds == 1) {
      				delete initStatus[pair[0]];
    			} else {
      				stat.rounds--;
    			}
 			}*/
			//for (let cog of initCogs) {
				for (let pair of Object.entries(cogs.status)) {
    				let stat = cogs.status[pair[0]];
    				if (stat.rounds == 1) {
      					delete cogs.status[pair[0]];
    				} else {
      					stat.rounds--;
    				}
 				}
			//}
			clickedGag = undefined;
			hideGagInfo();
			updateCalc();
		}

		//let calc = document.getElementById("calculate");
		let next = document.getElementById("next");
		let clear = document.getElementById("clear");
		//calc.addEventListener("click", calculate);
		next.addEventListener("click", nextTurn);
		clear.addEventListener("click", clearCalc);

		function gagHoverOn(gagName, event) {
			showGagInfo(gagName);
		}

		function gagButton(gagName, event) {
			let div = document.getElementById("calculation");
			fetch(`/gags?gag=${gagName}`).then(response => {
        		return response.json();
    		}).then((gag) => {
				clickedGag = gag.gag[0].gagname;
				gags.push(gag.gag[0]);
				calculate();
			}).catch((error) => {
        		;
    		});
		}

		function createTable() {
			let url = "/gags";
			document.getElementById("gags").addEventListener("mouseleave", () => {
				showGagInfo(clickedGag);
			});
			fetch(url).then(response => {
				return response.json();
    		}).then((body) => {
				let row;
				for (let data of body.gag) {
					if (data.id % 7 === 1) {
						row = document.createElement("tr");
						let label = document.createElement("td");
						label.textContent = data.gagtype;
						row.appendChild(label);
					}

					let cell = document.createElement("td");
					let button = document.createElement("button");
					//button.textContent = data.gagname;
					let image = document.createElement("img");
					image.src = `images/${data.gagname}_icon.png`;
					image.width = "30";
					image.height = "30";
					button.appendChild(image);
					button.id = data.gagname;
					button.addEventListener("click", (x) => gagButton(button.id, x));
					cell.addEventListener("mouseenter", (x) => gagHoverOn(button.id, x));
					//cell.addEventListener("mouseleave", hideGagInfo);
					cell.appendChild(button);
					row.appendChild(cell);

					if (data.id % 7 === 0) {
						document.getElementById("gags").appendChild(row);
					}
				}
    		}).catch((error) => {
        		;
    		});
		}
		
		createTable();
	</script>


</body></html>